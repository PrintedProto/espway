<!doctype html>

<html>
    <head>
        <meta charset='utf-8' />
        <meta name='viewport' content='width=device-width, initial-scale=1, user-scalable=no' />

        <title>ESPway</title>

        <style>
            body, html {
                margin: 0;
                padding: 0;
            }

            #joystick {
                background-color: black;
                width: 300px;
                height: 300px;
                display: block;
                margin: 50px auto;
            }
        </style>
    </head>

    <body>
        <canvas id='joystick'></canvas>

        <script>
            (function() {
                'use strict'

                window.addEventListener('load', () => {

                let byId = id => document.getElementById(id)
                // let ws = new WebSocket('ws://192.168.4.1/ws')
                // ws.binaryType = 'arraybuffer'
                // let sendBytes = bytes => ws.send((new Uint8Array(bytes)).buffer)

                let myCanvas = byId('joystick')
                let canvasWidth = myCanvas.offsetWidth,
                    canvasHeight = myCanvas.offsetHeight
                myCanvas.width = canvasWidth
                myCanvas.height = canvasHeight

                let mouseIsDown = false
                let hasCurrentTouch = false
                let currentTouchId = null
                let pageX = 0, pageY = 0

                window.addEventListener('mousemove', e => {
                    if (mouseIsDown) {
                        pageX = e.clientX
                        pageY = e.clientY
                    }
                })

                window.addEventListener('mousedown', e => {
                    mouseIsDown = true
                })

                window.addEventListener('mouseup', e => {
                    mouseIsDown = false
                    pageX = 0
                    pageY = 0
                })

                window.addEventListener('touchstart', e => {
                    if (!hasCurrentTouch) {
                        currentTouchId = e.changedTouches[0].identifier
                        hasCurrentTouch = true
                    }
                })

                window.addEventListener('touchend', e => {
                    if (hasCurrentTouch &&
                        e.changedTouches.item(currentTouchId) !== null) {
                        hasCurrentTouch = false
                        pageX = 0
                        pageY = 0
                    }
                })

                window.addEventListener('touchmove', e => {
                    let item = e.changedTouches.item(currentTouchId)
                    if (hasCurrentTouch && item !== null) {
                        pageX = item.pageX
                        pageY = item.pageY
                    }
                })


                window.setInterval(() => {
                    // send orientation
                    let x = 0, y = 0
                    if (hasCurrentTouch || mouseIsDown) {
                        x = pageX - myCanvas.offsetLeft - canvasWidth/2
                        y = (canvasHeight/2 - (pageY - myCanvas.offsetTop))
                        x /= canvasWidth / 2
                        y /= canvasHeight / 2

                        if (Math.abs(x) > 1 || Math.abs(y) > 1) {
                            x = 0
                            y = 0
                        }
                    }

                    console.log(x + ',' + y)
                }, 100);
                })
            })()
        </script>
    </body>
</html>

